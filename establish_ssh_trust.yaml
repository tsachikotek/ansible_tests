- name: copy all ssh key to Servers a
  hosts: all
  gather_facts: no
  become: true

  tasks:
    - name: Write the new ec2 instance host key to known hosts
      connection: local
      shell: "ssh-keyscan -H {{ ansible_ssh_host }} >> ~/.ssh/known_hosts"
      register: check_ssh
      ignore_errors: True

    - name: copy id_rsa.pub to all nodes
      #when: check_ssh is failed
      connection: local
      shell: "sshpass -p root12  ssh-copy-id -i /root/.ssh/id_rsa root@{{ ansible_ssh_host }}"
      ignore_errors: True

    - name: Create ssh dir
      file:
        path: /root/.ssh
        mode: 700
        state: directory
      delegate_to: localhost

    - name: (install) make ssh-key for root to all nodes
      shell: if ! [ -f /root/.ssh/id_rsa ] ; then ssh-keygen -t rsa -N "" -f /root/.ssh/id_rsa ; fi
      delegate_to: localhost

    - name: Create ssh dir
      file:
        path: /root/.ssh
        mode: 700
        state: directory

    - name: Provision sshd_config
      template:
        src: ssh_config.j2
        dest: /root/.ssh/config

    - name: accept new ssh fingerprints
      shell: |
        ssh-keyscan -H {{ hostvars[item]['ansible_host'] }} >> ~/.ssh/known_hosts
        ssh-keyscan -H {{ hostvars[item]['ha_ip'] }} >> ~/.ssh/known_hosts
      with_items: "{{ groups['vertica_group'] }}"

    - name: Read ssh key
      slurp:
        src: /root/.ssh/id_rsa.pub
      register: ssh_key
      delegate_to: localhost

    - name: Read ssh private key
      slurp:
        src: /root/.ssh/id_rsa
      register: ssh_private_key
      delegate_to: localhost

    - name: copy id_rsa.pub to all nodes
      lineinfile:
        line: "{{ ssh_key.content | b64decode }}"
        create: yes
        state: present
        mode: 600
        path: /root/.ssh/authorized_keys

    - name: Write ssh private key to remote machines under root
      copy:
        content: "{{ ssh_private_key.content | b64decode }}"
        dest: /root/.ssh/id_rsa
        mode: 600

    - name: Write ssh pub key to remote machines under root
      copy:
        content: "{{ ssh_key.content | b64decode }}"
        dest: /root/.ssh/id_rsa.pub
        mode: a+r

    - name: remove ssh-dss authorized key
      shell: "sed 's/^ssh-dss.\\+root@Allot$//' /root/.ssh/authorized_keys -i"

    - name: remove ssh-dss file
      shell: rm -rf /root/.ssh/id_dsa*
